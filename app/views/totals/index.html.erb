<div class="container-fluid mt-5">
  <% month_name = I18n.t('date.month_names')[@month.to_i].downcase %>

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h3 class="mb-0">Gastos de <span class="text-capitalize"><%= month_name %></span></h3>
      <div class="text-muted small">
        <%= @year %> • <%= @cards.length %> cartões
      </div>
    </div>

    <div class="d-flex gap-2">
      <!-- Ano -->
      <select id="totals-year" class="form-select form-select-sm" style="max-width: 120px;">
        <option selected value="<%= Date.today.year %>"><%= Date.today.year %></option>
        <% (2023..2030).reverse_each do |year| %>
          <option value="<%= year %>" <%= 'selected' if year.to_i == @year.to_i %>><%= year %></option>
        <% end %>
      </select>

      <!-- Mês -->
      <select id="totals-month" class="form-select form-select-sm" style="max-width: 170px;">
        <% @months.each_with_index do |month, index| %>
          <% next if index == 0 %>
          <option value="<%= index %>" <%= 'selected' if index == @month.to_i %>>
            <%= month.upcase %>
          </option>
        <% end %>
      </select>
    </div>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 row-cols-xxl-4 g-3">
  <% @cards.each do |card| %>
    <% style = card_style(card) %>
    <% color = card.color || style[:color] %>
    <% transactions = card.transactions_by_date(@month.to_s.rjust(2, '0'), Date.today.year.to_s) %>

    <div class="col">
      <div class="card shadow-sm credit-card">
        <!-- Header -->
        <div class="card-header bg-white d-flex align-items-center justify-content-between gap-2">
          <div class="d-flex align-items-center gap-2">
            <%= image_tag "cards/#{style[:logo]}", class: "cc-logo", alt: "#{card.name} logo", loading: "lazy" %>
            <div>
              <div class="fw-semibold"><%= card.name %></div>
              <div class="text-muted small"><%= transactions.size %> lançamentos</div>
            </div>
          </div>

          <div class="text-end">
            <div class="badge rounded-pill cc-total" style="background: <%= color %>;">
              R$ <%= sprintf("%.2f", card.total_transactions(@month)).tr('.', ',') %>
            </div>
            <div class="card-brand">
              <%= image_tag "flags/#{style[:flag]}", class: "cc-flag" if style[:flag].present? %>
            </div>
          </div>
        </div>

        <!-- Body -->
        <div class="card-body p-0">
          <% if transactions.present? %>
            <div class="cc-list">
              <% transactions.each do |t| %>
                <div class="cc-item px-3 py-2">
                  <div class="d-flex justify-content-between gap-2">
                    <div class="min-w-0">
                      <div class="d-flex align-items-center gap-2 min-w-0">
                        <% if t.category&.icon.present? %>
                          <%= image_tag "categories/#{t.category.icon}", class: "cc-cat-icon" %>
                        <% end %>

                        <div class="fw-semibold text-truncate">
                          <%= t.description %>
                          <% if t.installment_group_id.present? %>
                            <span class="text-muted small ms-1"><%= t.installment_label %></span>
                          <% end %>
                        </div>
                      </div>

                      <% details = t.responsible.presence || t.note %>
                      <% if details.present? %>
                        <div class="text-muted small text-truncate"><%= details %></div>
                      <% end %>
                    </div>

                    <div class="text-end flex-shrink-0">
                      <div class="fw-semibold">R$ <%= sprintf("%.2f", t.value).tr('.', ',') %></div>
                      <div class="small">
                        <span class="text-muted"><%= t.date.strftime("%d/%m") %></span>
                        <% if t.paid %>
                          <span class="badge bg-success-subtle text-success ms-1">Pago</span>
                        <% else %>
                          <span class="badge bg-secondary-subtle text-secondary ms-1">Aberto</span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
              <div class="cc-empty">
                Nenhuma transação neste mês.
              </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# Card OUTROS (transações sem cartão) %>
  <% style = card_style(OpenStruct.new(name: "OUTROS")) %>
  <% color = style[:color] %>
  <% transactions = @other_transactions %>

  <div class="col">
    <div class="card shadow-sm credit-card">
      <div class="card-header bg-white d-flex align-items-center justify-content-between gap-2">
        <div class="d-flex align-items-center gap-2">
          <%= image_tag "cards/creditcard.png", class: "cc-logo" %>
          <div>
            <div class="fw-semibold">OUTROS</div>
            <div class="text-muted small"><%= transactions.size %> lançamentos</div>
          </div>
        </div>

        <div class="text-end">
          <div class="badge rounded-pill cc-total" style="background: <%= color %>;">
            R$ <%= sprintf("%.2f", @other_total).tr('.', ',') %>
          </div>
        </div>
      </div>

      <div class="card-body p-0">
        <% if transactions.present? %>
          <div class="cc-list">
            <% transactions.each do |t| %>
              <div class="cc-item px-3 py-2">
                <div class="d-flex justify-content-between gap-2">
                  <div class="min-w-0">
                    <div class="d-flex align-items-center gap-2 min-w-0">
                      <% if t.category&.icon.present? %>
                        <%= image_tag "categories/#{t.category.icon}", class: "cc-cat-icon" %>
                      <% end %>

                      <div class="fw-semibold text-truncate">
                        <%= t.description %>
                        <% if t.installment_group_id.present? %>
                          <span class="text-muted small ms-1"><%= t.installment_label %></span>
                        <% end %>
                      </div>
                    </div>

                    <% details = t.responsible.presence || t.note %>
                    <% if details.present? %>
                      <div class="text-muted small text-truncate"><%= details %></div>
                    <% end %>
                  </div>

                  <div class="text-end flex-shrink-0">
                    <div class="fw-semibold">R$ <%= sprintf("%.2f", t.value).tr('.', ',') %></div>
                    <div class="small">
                      <span class="text-muted"><%= t.date.strftime("%d/%m") %></span>
                      <% if t.paid %>
                        <span class="badge bg-success-subtle text-success ms-1">Pago</span>
                      <% else %>
                        <span class="badge bg-secondary-subtle text-secondary ms-1">Aberto</span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="cc-empty">Nenhuma transação neste mês.</div>
        <% end %>
      </div>
    </div>
  </div>
</div>

